# Система контроля и управления доступом с контекстно-зависимой динамической аутентификацией

## Описание

Данный проект представляет собой прототип системы контроля и управления доступом (СКУД), реализующий оригинальный метод аутентификации на основе ранговой комбинации и истории перемещений. Система обеспечивает динамическую проверку подлинности пользователя с учётом контекста его перемещений и предоставляет гибкую модель управления доступом по принципу «водопада»: пользователь с более высоким рангом имеет доступ ко всем зонам, разрешённым для пользователей с более низкими рангами.

Ключевые особенности:
- Аутентификация на основе криптографически стойкого токена, генерируемого с использованием HMAC-SHA256.
- Ранговая система, вдохновлённая покерными комбинациями, где более редкие комбинации соответствуют более высокому уровню привилегий.
- Контекстно-зависимый контроль доступа, учитывающий историю перемещений пользователя.
- Защита от replay-атак за счёт использования одноразового случайного числа (nonce).
- Механизм временной блокировки после трёх неудачных попыток аутентификации.
- Веб-интерфейс для управления пользователями и мониторинга событий.

## Структура проекта

```
myproj/
├── app.py                 # Веб-сервер на Flask
├── auth_logic.py          # Логика вычисления рангов и валидации
├── database.py            # Работа с базой данных SQLite
├── personalize.py         # Скрипт персонализации пользователей
├── test_full.py           # Скрипт консольной эмуляции прохода
├── skud.db                # База данных (создаётся автоматически)
└── templates/             # Шаблоны веб-интерфейса
    ├── base.html
    ├── index.html
    ├── users.html
    └── logs.html
```

## Требования

- Python 3.9 или выше
- Библиотеки Python:
  - flask
  - cryptography

## Установка

1. Клонируйте или распакуйте проект в локальную директорию.
2. Установите необходимые зависимости:
   ```
   pip install flask cryptography
   ```

## Использование

### Персонализация пользователя

Для добавления нового пользователя в систему используйте скрипт `personalize.py`:

```
python personalize.py --uid <уникальный_идентификатор> --rank <ранг> [--name <имя>]
```

Где:
- `--uid` — обязательный уникальный идентификатор пользователя (например, серийный номер карты).
- `--rank` — обязательный ранг пользователя (целое число от 3 до 9).
- `--name` — необязательное имя пользователя для логирования.

Пример:
```
python personalize.py --uid ADMIN_01 --rank 9 --name "Администратор"
```

### Запуск веб-интерфейса

Для запуска веб-панели управления выполните:

```
python app.py
```

После запуска откройте в браузере адрес http://localhost:5000.

Веб-интерфейс предоставляет следующие функции:
- Эмуляция прохода через СКУД с выбором пользователя и зон.
- Просмотр списка зарегистрированных пользователей.
- Просмотр журнала событий с указанием причин отказа или разрешения доступа.
- Добавление новых пользователей через веб-форму.

### Консольная эмуляция

Для тестирования логики аутентификации без веб-интерфейса используйте скрипт `test_full.py`. Отредактируйте файл, указав необходимые параметры (UID пользователя, историю перемещений, запрашиваемую зону), и запустите:

```
python test_full.py
```

## Архитектура безопасности

### Модель привилегий

Каждому пользователю присваивается ранг от 3 до 9, определяющий его уровень доступа:
- Ранг 3: Посетители (доступ только к зонам с требованием ранга 3).
- Ранг 4-5: Основной персонал (офис, склад).
- Ранг 6-7: Технический персонал и менеджеры.
- Ранг 8-9: Администраторы и сотрудники информационной безопасности.

Каждая зона в системе имеет требование минимального ранга для доступа. Пользователь может войти в зону, если его ранг больше или равен требуемому рангу зоны.

### Аутентификация

Процесс аутентификации включает следующие шаги:
1. Считыватель генерирует криптографически стойкое случайное число (nonce).
2. Носитель пользователя вычисляет токен T = HMAC-SHA256(K, nonce || история_перемещений).
3. Из токена T извлекается комбинация из 5 чисел, по которой вычисляется ранг.
4. Доступ разрешается, если вычисленный ранг совпадает с рангом пользователя.

Для пользователей с высоким рангом (7-9) система автоматически выполняет до 5000 попыток генерации nonce, чтобы найти комбинацию с требуемым рангом.

### Контекстная проверка

Система проверяет корректность маршрута перемещений. Например, из зоны «Выход» (ID 999) разрешён переход только в зону «Вход» (ID 0). Также проверяется, что все зоны в истории перемещений существуют в системе.

### Защита от атак

- Replay-атаки: предотвращаются за счёт использования одноразового nonce.
- Brute-force атаки: после трёх неудачных попыток аутентификации для одного UID следует блокировка на одну минуту.
- Клонирование: в реальной системе с использованием NFC-карт NTAG 424 DNA секретный ключ защищён технологией ChipDNA и недоступен для извлечения.

## Тестирование

Рекомендуется протестировать следующие сценарии:
1. Успешный проход пользователя с достаточным рангом.
2. Отказ в доступе из-за недостаточного ранга.
3. Отказ в доступе из-за нарушения контекста (например, вход после выхода).
4. Блокировка после трёх неудачных попыток.
5. Попытка доступа с несуществующим UID или в несуществующую зону.
6. Попытка доступа с повреждённой историей перемещений.

## Дальнейшее развитие

Возможные направления развития системы:
- Интеграция с физическими NFC-считывателями и картами NTAG 424 DNA.
- Поддержка мобильных устройств с NFC.
- Расширенная логика маршрутов (например, обязательный проход через ресепшн перед доступом в офис).
- Интеграция с облачными сервисами и централизованное управление.
- Добавление биометрической аутентификации как дополнительного фактора.
